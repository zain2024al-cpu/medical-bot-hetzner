name: ğŸš€ Deploy to Hetzner VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸš€ Deploy to Hetzner
      run: |
        echo "ğŸš€ Starting deployment to Hetzner VPS..."
        echo "Server: ${{ secrets.HETZNER_HOST }}"

        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø´Ø±ÙˆØ¹
        DEPLOY_DIR="/tmp/medical-bot-deploy-$GITHUB_RUN_ID"
        mkdir -p $DEPLOY_DIR

        # Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª (Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)
        rsync -av --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' \
          --exclude='venv' --exclude='exports' --exclude='logs' \
          --exclude='.env' --exclude='config.env' \
          ./ $DEPLOY_DIR/

        # Ø±ÙØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ±
        echo "ğŸ“¤ Uploading project files..."
        rsync -avz --delete --exclude='.git' --exclude='__pycache__' \
          --exclude='venv' --exclude='exports' --exclude='logs' \
          -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
          $DEPLOY_DIR/ botuser@${{ secrets.HETZNER_HOST }}:~/medical-bot/

        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø¤Ù‚Øª
        rm -rf $DEPLOY_DIR

        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
        echo "ğŸ”„ Restarting bot on server..."
        ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no botuser@${{ secrets.HETZNER_HOST }} << 'EOF'
          cd ~/medical-bot

          # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          source venv/bin/activate

          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ)
          pip install -r requirements.txt

          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ systemd daemon
          sudo systemctl daemon-reload

          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
          sudo systemctl restart medical-bot

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
          sleep 5
          sudo systemctl status medical-bot --no-pager -l

          echo "âœ… Deployment completed successfully!"
        EOF

    - name: ğŸ“Š Deployment Status
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Commit: ${GITHUB_SHA}"
        echo "ğŸ‘¤ Author: ${GITHUB_ACTOR}"