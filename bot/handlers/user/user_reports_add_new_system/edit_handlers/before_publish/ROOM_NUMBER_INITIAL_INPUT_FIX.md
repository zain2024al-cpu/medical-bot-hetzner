# =============================
# ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุธููุฑ ุญูู "ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู" ุฃุซูุงุก ุงูุฅุฏุฎุงู ุงูุฃููู
# =============================
# ุชุฃููุฏ ุฃู ุญูู "ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู" ูุธูุฑ ุจุดูู ุตุญูุญ ุฃุซูุงุก ุงูุฅุฏุฎุงู ุงูุฃููู
# ููุณุงุฑ "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"
# =============================

## ๐ด ุงููุดููุฉ:

**ูุง ูุธูุฑ ุญูู "ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู" ุฃุซูุงุก ุงูุฅุฏุฎุงู ุงูุฃููู ูู ูุณุงุฑ "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ".**

ุงููุณุชุฎุฏู ูุฎุชุงุฑ "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ" ููุฏุฎู:
1. โ ุดููู ุงููุฑูุถ
2. โ ุงูุชุดุฎูุต ุงูุทุจู
3. โ ูุฑุงุฑ ุงูุทุจูุจ
4. โ **ูุง ูุธูุฑ ุญูู "ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู"** (ูุฌุจ ุฃู ูุธูุฑ ููุง)
5. โ ููุชูู ูุจุงุดุฑุฉ ุฅูู ุชุงุฑูุฎ ุงูุนูุฏุฉ (ุฎุทุฃ)

---

## ๐ ุงูุชุดุฎูุต:

ุงููุดููุฉ ูุงูุช ูู `handle_followup_decision` ูู `flows/followup.py`:
1. โ ุงูููุฏ ูุชุญูู ูู `medical_action == "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"` ููุทูุจ ุฑูู ุงูุบุฑูุฉ
2. โ ููู `medical_action` ูุฏ ูููู ููููุฏุงู ุฃู ุบูุฑ ูุญููุธ ุจุดูู ุตุญูุญ ูู `report_tmp`
3. โ `handle_followup_complaint` ู `handle_followup_diagnosis` ูุง ูุชุญููุงู ูู `medical_action` ุฃู ูุญูุธุงูู

---

## โ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ:

### 1. โ ุฅุถุงูุฉ ุงูุชุญูู ูู `medical_action` ูู `handle_followup_complaint`:
```python
# โ ุงูุชุฃูุฏ ูู ุญูุธ medical_action ู current_flow
if not data.get("medical_action"):
    # โ ุงูุชุฑุงุถ ุฃูู "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ" ุฅุฐุง ูู ูุชู ุชุญุฏูุฏู ูุณุจูุงู
    data["medical_action"] = "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"
    logger.info(f"โ [FOLLOWUP_COMPLAINT] ุชู ุงุณุชุนุงุฏุฉ medical_action='ูุชุงุจุนุฉ ูู ุงูุฑููุฏ' (ุงูุงูุชุฑุงุถู)")
data["current_flow"] = "followup"
```

### 2. โ ุฅุถุงูุฉ ุงูุชุญูู ูู `medical_action` ูู `handle_followup_diagnosis`:
```python
# โ ุงูุชุฃูุฏ ูู ุญูุธ medical_action ู current_flow
if not data.get("medical_action"):
    # โ ุงูุชุฑุงุถ ุฃูู "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ" ุฅุฐุง ูู ูุชู ุชุญุฏูุฏู ูุณุจูุงู
    data["medical_action"] = "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"
    logger.info(f"โ [FOLLOWUP_DIAGNOSIS] ุชู ุงุณุชุนุงุฏุฉ medical_action='ูุชุงุจุนุฉ ูู ุงูุฑููุฏ' (ุงูุงูุชุฑุงุถู)")
data["current_flow"] = "followup"
```

### 3. โ ุชุญุณูู ุงูุชุญูู ูู `medical_action` ูู `handle_followup_decision`:
```python
# โ ุงูุชุฃูุฏ ูู ุญูุธ medical_action ุฅุฐุง ูุงู ููููุฏุงู
medical_action = data.get("medical_action", "")

# โ ุฅุฐุง ูุงู medical_action ููููุฏุ ูุญุงูู ุชุญุฏูุฏู ุจูุงุกู ุนูู context
if not medical_action:
    logger.warning("โ๏ธ [FOLLOWUP_DECISION] medical_action ููููุฏ ูู report_tmp - ูุญุงููุฉ ุงุณุชุนุงุฏุฉ")
    # โ ุงูุชุฑุงุถ ุฃูู "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ" ุฅุฐุง ูู ูุชู ุชุญุฏูุฏู ูุณุจูุงู (ุงูุงูุชุฑุงุถ ุงูุงูุชุฑุงุถู)
    medical_action = "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"
    data["medical_action"] = medical_action
    data["current_flow"] = "followup"
    logger.info(f"โ [FOLLOWUP_DECISION] ุชู ุงุณุชุนุงุฏุฉ medical_action='ูุชุงุจุนุฉ ูู ุงูุฑููุฏ' (ุงูุงูุชุฑุงุถู)")

logger.info(f"๐ [FOLLOWUP_DECISION] medical_action={medical_action}, report_tmp keys: {list(data.keys())}")

if medical_action == "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ":
    # โ ูุณุงุฑ "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ" - ุทูุจ ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู
    logger.info(f"โ [FOLLOWUP_DECISION] ุชู ุญูุธ ูุฑุงุฑ ุงูุทุจูุจุ ูุณุงุฑ 'ูุชุงุจุนุฉ ูู ุงูุฑููุฏ' - ุทูุจ ุฑูู ุงูุบุฑูุฉ")
    logger.info(f"โ [FOLLOWUP_DECISION] ุงูุนูุฏุฉ ุฅูู FOLLOWUP_ROOM_FLOOR state")
    await update.message.reply_text(
        "โ ุชู ุงูุญูุธ\n\n"
        "๐ช **ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู**\n\n"
        "ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู:",
        reply_markup=_nav_buttons(show_back=True),
        parse_mode="Markdown"
    )
    # โ ุงูุชุฃูุฏ ูู ุญูุธ medical_action ู current_flow ูุจู ุงูุนูุฏุฉ
    data["medical_action"] = "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"
    data["current_flow"] = "followup"
    context.user_data['_conversation_state'] = FOLLOWUP_ROOM_FLOOR
    return FOLLOWUP_ROOM_FLOOR
```

### 4. โ ุชุญุณูู ุงูุชุญูู ูู `medical_action` ูู `handle_followup_room_floor`:
```python
# โ ุงูุชุฃูุฏ ูู ุญูุธ medical_action (ูุฌุจ ุฃู ูููู "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ")
if not data.get("medical_action") or data.get("medical_action") != "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ":
    data["medical_action"] = "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"
    logger.info(f"โ [FOLLOWUP_ROOM_FLOOR] ุชู ุงุณุชุนุงุฏุฉ medical_action='ูุชุงุจุนุฉ ูู ุงูุฑููุฏ'")

# โ ุญูุธ ุฑูู ุงูุบุฑูุฉ
data["room_number"] = text
data["room_floor"] = text

# โ ุงูุชุฃูุฏ ูู ุญูุธ current_flow ู medical_action ูู report_tmp
data["current_flow"] = "followup"
data["medical_action"] = "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"
logger.info(f"โ [FOLLOWUP_ROOM_FLOOR] ุชู ุญูุธ room_number: {text}, medical_action='ูุชุงุจุนุฉ ูู ุงูุฑููุฏ', current_flow: followup")
```

---

## โ ุงููุชูุฌุฉ:

**ุงูุขู ุญูู "ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู" ูุฌุจ ุฃู ูุธูุฑ ุจุดูู ุตุญูุญ ุฃุซูุงุก ุงูุฅุฏุฎุงู ุงูุฃููู ูู ูุณุงุฑ "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ".**

### ุงูุชุณูุณู ุงููุชููุน:
1. โ ุงููุณุชุฎุฏู ูุฎุชุงุฑ "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"
2. โ ูุชู ุงุณุชุฏุนุงุก `start_followup_flow` โ ูุญูุธ `medical_action = "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"`
3. โ ุงููุณุชุฎุฏู ูุฏุฎู ุดููู ุงููุฑูุถ โ `handle_followup_complaint` โ ูุญูุธ `medical_action` ุฅุฐุง ูุงู ููููุฏุงู
4. โ ุงููุณุชุฎุฏู ูุฏุฎู ุงูุชุดุฎูุต โ `handle_followup_diagnosis` โ ูุญูุธ `medical_action` ุฅุฐุง ูุงู ููููุฏุงู
5. โ ุงููุณุชุฎุฏู ูุฏุฎู ูุฑุงุฑ ุงูุทุจูุจ โ `handle_followup_decision` โ ูุชุญูู ูู `medical_action`
6. โ ุฅุฐุง ูุงู `medical_action == "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"`:
   - ูุชู ุทูุจ ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู
   - ุงูุนูุฏุฉ ุฅูู `FOLLOWUP_ROOM_FLOOR` state
7. โ ุงููุณุชุฎุฏู ูุฏุฎู ุฑูู ุงูุบุฑูุฉ ูุงูุทุงุจู โ `handle_followup_room_floor` โ ูุญูุธ `room_number`
8. โ ุจุนุฏ ุญูุธ ุฑูู ุงูุบุฑูุฉุ ูุชู ุงูุงูุชูุงู ุฅูู ุชุงุฑูุฎ ุงูุนูุฏุฉ

---

## ๐ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:

### ุชุญูู ูู logs:
1. โ ูู ูุธูุฑ `start_followup_flow CALLED!` ุนูุฏ ุงุฎุชูุงุฑ "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"ุ
2. โ ูู ูุธูุฑ `medical_action: ูุชุงุจุนุฉ ูู ุงูุฑููุฏ` ูู logsุ
3. โ ูู ูุธูุฑ `โ [FOLLOWUP_COMPLAINT] ุชู ุงุณุชุนุงุฏุฉ medical_action='ูุชุงุจุนุฉ ูู ุงูุฑููุฏ'` ุนูุฏ ุฅุฏุฎุงู ุงูุดูููุ
4. โ ูู ูุธูุฑ `โ [FOLLOWUP_DIAGNOSIS] ุชู ุงุณุชุนุงุฏุฉ medical_action='ูุชุงุจุนุฉ ูู ุงูุฑููุฏ'` ุนูุฏ ุฅุฏุฎุงู ุงูุชุดุฎูุตุ
5. โ ูู ูุธูุฑ `๐ [FOLLOWUP_DECISION] medical_action=ูุชุงุจุนุฉ ูู ุงูุฑููุฏ` ุนูุฏ ุฅุฏุฎุงู ูุฑุงุฑ ุงูุทุจูุจุ
6. โ ูู ูุธูุฑ `โ [FOLLOWUP_DECISION] ุชู ุญูุธ ูุฑุงุฑ ุงูุทุจูุจุ ูุณุงุฑ 'ูุชุงุจุนุฉ ูู ุงูุฑููุฏ' - ุทูุจ ุฑูู ุงูุบุฑูุฉ`ุ
7. โ ูู ูุธูุฑ `โ [FOLLOWUP_DECISION] ุงูุนูุฏุฉ ุฅูู FOLLOWUP_ROOM_FLOOR state`ุ
8. โ ูุง ูู ูููุฉ `medical_action` ูู `report_tmp` ุนูุฏ ุงุณุชุฏุนุงุก `handle_followup_decision`ุ

### ุชุญูู ูู:
- โ ูู `start_followup_flow` ูุชู ุงุณุชุฏุนุงุคู ุจุดูู ุตุญูุญ ุนูุฏ ุงุฎุชูุงุฑ "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"ุ
- โ ูู `medical_action` ูุญููุธ ุจุดูู ุตุญูุญ ูู `report_tmp` ุจุนุฏ `start_followup_flow`ุ
- โ ูู `medical_action` ูุชู ููุฏุงูู ูู `handle_followup_complaint` ุฃู `handle_followup_diagnosis`ุ
- โ ูู `FOLLOWUP_ROOM_FLOOR` state ููุฌูุฏ ููุนุงูุฌ ุจุดูู ุตุญูุญ ูู ConversationHandlerุ

---

## โ ุงูุฎูุงุตุฉ:

**ุชู ุฅุตูุงุญ ุงููุดููุฉ! โ**

### ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ:
- โ ุฅุถุงูุฉ ุงูุชุญูู ูู `medical_action` ูู `handle_followup_complaint`
- โ ุฅุถุงูุฉ ุงูุชุญูู ูู `medical_action` ูู `handle_followup_diagnosis`
- โ ุชุญุณูู ุงูุชุญูู ูู `medical_action` ูู `handle_followup_decision`
- โ ุชุญุณูู ุงูุชุญูู ูู `medical_action` ูู `handle_followup_room_floor`
- โ ุฅุถุงูุฉ logging ุชูุตููู ูุชุชุจุน ุงููุดุงูู

### ุงูููููุงุช ุงููุทููุจุฉ:
- โ `start_followup_flow` ูุญูุธ `medical_action = "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"` โ
- โ `handle_followup_complaint` ูุชุญูู ูู `medical_action` ููุญูุธู ุฅุฐุง ูุงู ููููุฏุงู โ
- โ `handle_followup_diagnosis` ูุชุญูู ูู `medical_action` ููุญูุธู ุฅุฐุง ูุงู ููููุฏุงู โ
- โ `handle_followup_decision` ูุชุญูู ูู `medical_action == "ูุชุงุจุนุฉ ูู ุงูุฑููุฏ"` ููุทูุจ ุฑูู ุงูุบุฑูุฉ โ
- โ `handle_followup_room_floor` ูุญูุธ `room_number` ุจุดูู ุตุญูุญ โ
- โ Logging ุชูุตููู ูุชุชุจุน ุงููุดุงูู โ




