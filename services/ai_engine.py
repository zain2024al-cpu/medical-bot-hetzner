import asyncio
import os
import logging
from dotenv import load_dotenv
from db.models import Report, Patient, Hospital
from bot.shared_utils import clean_input as clean_text, summarize_text

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
load_dotenv(".env")
load_dotenv("config.env")

# Logging
logger = logging.getLogger(__name__)

# OpenAI Settings
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o")

# ====================================================
# ğŸ¤– ÙˆØ­Ø¯Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
# Ù…Ø­Ø¯Ø«Ø© Ù„Ø¯Ø¹Ù… OpenAI + Fallback
# ====================================================

async def analyze_reports(input_text: str) -> str:
    """
    ØªØ­Ù„ÙŠÙ„ Ù†Øµ Ø·Ø¨ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenAI (Ø¥Ø°Ø§ Ù…ØªÙˆÙØ±) Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ Ø¨Ø³ÙŠØ·
    
    Args:
        input_text: Ø§Ù„Ù†Øµ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ù„ÙŠÙ„Ù‡
    
    Returns:
        str: Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„
    """
    try:
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ
        cleaned = clean_text(input_text)
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenAI Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
        if OPENAI_API_KEY:
            logger.info("ğŸ¤– Using OpenAI for analysis")
            return await analyze_with_openai(cleaned)
        else:
            logger.info("ğŸ¤– Using simple analysis (no OpenAI)")
            return await analyze_simple(cleaned)
            
    except Exception as e:
        logger.error(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: {e}")
        return f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: {e}"


async def analyze_with_openai(text: str) -> str:
    """ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… ÙˆØ´Ø§Ù…Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenAI API"""
    try:
        from openai import OpenAI
        
        client = OpenAI(api_key=OPENAI_API_KEY)
        
        def call_openai():
            response = client.chat.completions.create(
                model=OPENAI_MODEL,
                messages=[
                    {
                        "role": "system",
                        "content": """Ø£Ù†Øª Ø·Ø¨ÙŠØ¨ Ø§Ø³ØªØ´Ø§Ø±ÙŠ Ù…ØªØ®ØµØµ ÙˆØ®Ø¨ÙŠØ± ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ©. 
Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø·Ø¨ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆÙ…ØªÙ‚Ø¯Ù…Ø§Ù‹ ÙŠØªØ¶Ù…Ù†:

ğŸ“‹ **Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø­ØªÙ…Ù„:**
- Ø§Ø°ÙƒØ± 3-5 ØªØ´Ø®ÙŠØµØ§Øª Ù…Ø­ØªÙ…Ù„Ø© Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©
- Ø­Ø¯Ø¯ Ø¯Ø±Ø¬Ø© Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© ÙƒÙ„ ØªØ´Ø®ÙŠØµ (Ø¹Ø§Ù„ÙŠ/Ù…ØªÙˆØ³Ø·/Ù…Ù†Ø®ÙØ¶)
- Ø§Ø°ÙƒØ± Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙØ±ÙŠÙ‚ÙŠ Ø§Ù„Ù…Ù‡Ù…

ğŸš¨ **Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø© ÙˆØ§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:**
- Ø­Ø¯Ø¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©: Ø­Ø±Ø¬/Ø¹Ø§Ù„ÙŠ/Ù…ØªÙˆØ³Ø·/Ù…Ù†Ø®ÙØ¶
- Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„Ø§Ù‹ ÙÙˆØ±ÙŠØ§Ù‹ØŸ
- Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØªØ¯Ø®Ù„ØŸ

âš ï¸ **Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ­Ø°ÙŠØ±ÙŠØ©:**
- Ø§Ø°ÙƒØ± Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª Ø®Ø·Ø±Ø© (Red Flags)
- Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„ØªÙŠ ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù‚Ù„Ù‚
- Ù…ØªÙ‰ ÙŠØ¬Ø¨ Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ø§Ù‹ØŸ

ğŸ” **Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- ÙØ­ÙˆØµØ§Øª Ø£ÙˆÙ„ÙŠØ© Ø¹Ø§Ø¬Ù„Ø©
- ØªØ­Ø§Ù„ÙŠÙ„ Ù…Ø®Ø¨Ø±ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©
- Ø£Ø´Ø¹Ø© Ø£Ùˆ ØµÙˆØ± ØªØ´Ø®ÙŠØµÙŠØ©
- ÙØ­ÙˆØµØ§Øª Ù…ØªØ®ØµØµØ© Ø¥Ø¶Ø§ÙÙŠØ©

ğŸ’Š **Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©:**
- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙˆØ±ÙŠØ© (First Aid)
- Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬ÙŠØ© Ø£ÙˆÙ„ÙŠØ©
- Ø£Ø¯ÙˆÙŠØ© Ù…Ù‚ØªØ±Ø­Ø© (Ø¨Ø­Ø°Ø± ÙˆØªØ­Øª Ø¥Ø´Ø±Ø§Ù)
- ØªØ¯Ø®Ù„Ø§Øª ØºÙŠØ± Ø¯ÙˆØ§Ø¦ÙŠØ©

ğŸ¥ **Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­:**
- Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø·ÙˆØ§Ø±Ø¦/Ø¹ÙŠØ§Ø¯Ø©/Ù…Ù†Ø²Ù„)
- Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
- Ù‡Ù„ ÙŠØ­ØªØ§Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø³ØªØ´ÙÙ‰ØŸ

ğŸ“Š **Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:**
- Ø®Ø·Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
- Ø¹Ù„Ø§Ù…Ø§Øª ØªØ­Ø³Ù† ÙŠØ¬Ø¨ Ù…Ø±Ø§Ù‚Ø¨ØªÙ‡Ø§
- Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¯Ù‡ÙˆØ± ÙŠØ¬Ø¨ Ø§Ù„Ø­Ø°Ø± Ù…Ù†Ù‡Ø§

Ø§Ù„Ø±Ø¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†:
- Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆÙ…ÙØµÙ„Ø§Ù‹ (Ù„Ø§ ØªØ®ØªØµØ±!)
- Ù…Ù†Ø¸Ù…Ø§Ù‹ Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­
- Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰
- Ø§Ø­ØªØ±Ø§ÙÙŠØ§Ù‹ ÙˆØ¯Ù‚ÙŠÙ‚Ø§Ù‹
- ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø·Ø¨ÙŠØ© Ù‚ÙŠÙ‘Ù…Ø©"""
                    },
                    {
                        "role": "user",
                        "content": f"""Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø·Ø¨ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆÙ…ØªÙ‚Ø¯Ù…Ø§Ù‹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©:

{text}

ØªØ°ÙƒØ±: Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆÙ…ÙØµÙ„Ø§Ù‹ ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„ØµØ­ÙŠØ­."""
                    }
                ],
                temperature=0.4,
                max_tokens=1500  # Ø²ÙŠØ§Ø¯Ø© ÙƒØ¨ÙŠØ±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„
            )
            return response.choices[0].message.content.strip()
        
        result = await asyncio.to_thread(call_openai)
        return f"ğŸ§  **ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù…ØªÙ‚Ø¯Ù… (GPT-4o):**\n\n{result}\n\nâš¡ *ØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…*"
        
    except Exception as e:
        logger.error(f"OpenAI Error: {e}")
        # Fallback Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·
        return await analyze_simple(text)


async def analyze_simple(text: str) -> str:
    """ØªØ­Ù„ÙŠÙ„ Ù…Ø­Ø³Ù‘Ù† Ø¨Ø¯ÙˆÙ† OpenAI (Fallback Ø°ÙƒÙŠ)"""
    await asyncio.sleep(0.5)
    
    cleaned = text.lower()
    
    # ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù…ÙˆØ³Ø¹Ø©
    keywords_analysis = {
        'cardiac': ['ØµØ¯Ø±', 'chest', 'Ù‚Ù„Ø¨', 'heart', 'Ø®ÙÙ‚Ø§Ù†', 'palpitation', 'Ø°Ø¨Ø­Ø©', 'angina'],
        'respiratory': ['ØªÙ†ÙØ³', 'breath', 'Ø³Ø¹Ø§Ù„', 'cough', 'Ø±Ø¦Ø©', 'lung', 'Ø¶ÙŠÙ‚', 'dyspnea'],
        'fever': ['Ø­Ù…Ù‰', 'fever', 'Ø­Ø±Ø§Ø±Ø©', 'temperature', 'Ø³Ø®ÙˆÙ†Ø©'],
        'pain': ['Ø£Ù„Ù…', 'pain', 'ÙˆØ¬Ø¹', 'Ù…Ø¤Ù„Ù…', 'painful'],
        'infection': ['Ø§Ù„ØªÙ‡Ø§Ø¨', 'infection', 'Ø¹Ø¯ÙˆÙ‰', 'infected', 'ØµØ¯ÙŠØ¯', 'pus'],
        'pressure': ['Ø¶ØºØ·', 'pressure', 'hypertension', 'hypotension'],
        'diabetes': ['Ø³ÙƒØ±', 'diabetes', 'Ø³ÙƒØ±ÙŠ', 'glucose'],
        'emergency': ['Ø­Ø§Ø¯', 'acute', 'Ø´Ø¯ÙŠØ¯', 'severe', 'Ø·Ø§Ø±Ø¦', 'emergency'],
        'neurological': ['ØµØ¯Ø§Ø¹', 'headache', 'Ø¯ÙˆØ®Ø©', 'dizzy', 'Ø¥ØºÙ…Ø§Ø¡', 'unconscious']
    }
    
    detected = []
    for category, keywords in keywords_analysis.items():
        if any(kw in cleaned for kw in keywords):
            detected.append(category)
    
    # ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©
    result = "ğŸ“‹ **ØªØ­Ù„ÙŠÙ„ Ù…Ø­Ø³Ù‘Ù† (Ø¨Ø¯ÙˆÙ† OpenAI):**\n\n"
    
    if 'cardiac' in detected or 'respiratory' in detected:
        result += """ğŸš¨ **ØªØ­Ø°ÙŠØ± Ù…Ù‡Ù…:**
Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ù‚Ø¯ ØªØ´ÙŠØ± Ù„Ù…Ø´ÙƒÙ„Ø© Ù‚Ù„Ø¨ÙŠØ© Ø£Ùˆ ØªÙ†ÙØ³ÙŠØ© ØªØ­ØªØ§Ø¬ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ Ø¹Ø§Ø¬Ù„Ø§Ù‹.

ğŸ“‹ **Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø­ØªÙ…Ù„:**
- Ù…Ø´ÙƒÙ„Ø© Ù‚Ù„Ø¨ÙŠØ© (Ø°Ø¨Ø­Ø© ØµØ¯Ø±ÙŠØ©ØŒ Ø¬Ù„Ø·Ø©)
- Ù…Ø´ÙƒÙ„Ø© ØªÙ†ÙØ³ÙŠØ© (Ø±Ø¨ÙˆØŒ Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±Ø¦ÙˆÙŠ)
- Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„Ø§Ù‹ ÙÙˆØ±ÙŠØ§Ù‹

ğŸ” **Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- ECG ÙÙˆØ±ÙŠ
- ØªØ­Ø§Ù„ÙŠÙ„ Troponin
- Ø£Ø´Ø¹Ø© ØµØ¯Ø± (X-Ray)
- Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†

âœ… **Ø§Ù„ØªÙˆØµÙŠØ©:** ØªÙˆØ¬Ù‡ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ø§Ù‹!"""

    elif 'emergency' in detected:
        result += """ğŸ”´ **Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø© Ù…Ø­ØªÙ…Ù„Ø©!**

âš ï¸ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ ØªØ´ÙŠØ± Ù„Ø­Ø§Ù„Ø© Ø­Ø§Ø¯Ø© ØªØ­ØªØ§Ø¬ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ ÙÙˆØ±ÙŠØ§Ù‹

ğŸ¥ **Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**
- ØªÙˆØ¬Ù‡ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ø§Ù‹
- Ù„Ø§ ØªÙ†ØªØ¸Ø±
- Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ø³Ø¹Ø§Ù Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±

âœ… Ø§Ù„ÙˆÙ‚Øª Ø­Ø±Ø¬ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø§Øª"""

    elif 'fever' in detected and 'infection' in detected:
        result += """ğŸ¦  **Ø§Ù„ØªÙ‡Ø§Ø¨ Ù…Ø¹ Ø­Ù…Ù‰:**

ğŸ“‹ **Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø­ØªÙ…Ù„:**
- Ø¹Ø¯ÙˆÙ‰ Ø¨ÙƒØªÙŠØ±ÙŠØ©
- Ø§Ù„ØªÙ‡Ø§Ø¨ ÙÙŠØ±ÙˆØ³ÙŠ
- Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ

ğŸ” **Ø§Ù„ÙØ­ÙˆØµØ§Øª:**
- CBC (ØªØ¹Ø¯Ø§Ø¯ Ø¯Ù… ÙƒØ§Ù…Ù„)
- CRP
- Ù…Ø²Ø±Ø¹Ø© Ø¥Ø°Ø§ Ù„Ø²Ù…

ğŸ’Š **Ø§Ù„ØªÙˆØµÙŠØ§Øª:**
- Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ø¨ÙŠØ¨
- Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ
- Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©"""

    elif 'pain' in detected:
        result += """âš ï¸ **Ø£Ù„Ù… ÙŠØ­ØªØ§Ø¬ ØªÙ‚ÙŠÙŠÙ…:**

ğŸ“‹ **ÙŠÙÙ†ØµØ­ Ø¨Ù€:**
- ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£Ù„Ù… Ø¨Ø¯Ù‚Ø©
- Ù‚ÙŠØ§Ø³ Ø´Ø¯Ø© Ø§Ù„Ø£Ù„Ù… (1-10)
- Ø£Ø´Ø¹Ø© Ø£Ùˆ ØµÙˆØ± ØªØ´Ø®ÙŠØµÙŠØ©
- Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ¨ Ù…ØªØ®ØµØµ

ğŸ” **ÙØ­ÙˆØµØ§Øª Ù…Ù‚ØªØ±Ø­Ø©:**
- Ø£Ø´Ø¹Ø© Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…ØµØ§Ø¨Ø©
- ØªØ­Ø§Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
- ÙØ­Øµ Ø³Ø±ÙŠØ±ÙŠ Ø´Ø§Ù…Ù„"""

    elif 'pressure' in detected:
        result += """ğŸ’“ **Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¶ØºØ· Ø§Ù„Ø¯Ù…:**

ğŸ“Š **Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**
- Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¶ØºØ· Ø¹Ø¯Ø© Ù…Ø±Ø§Øª
- Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ©
- ØªØ­Ø§Ù„ÙŠÙ„ (ÙƒÙ„Ù‰ØŒ Ù‚Ù„Ø¨)
- Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©

âœ… Ø¶Ø¨Ø· Ø§Ù„Ø¶ØºØ· Ù…Ù‡Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª"""

    elif 'diabetes' in detected:
        result += """ğŸ©¸ **Ù…Ø¤Ø´Ø±Ø§Øª Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø³ÙƒØ±ÙŠ:**

ğŸ” **Ø§Ù„ÙØ­ÙˆØµØ§Øª:**
- ÙØ­Øµ Ø³ÙƒØ± ØµØ§Ø¦Ù…
- HbA1c
- Ø³ÙƒØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
- ÙˆØ¸Ø§Ø¦Ù ÙƒÙ„Ù‰

ğŸ“Š **Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:**
- Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ
- Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ©
- ÙØ­Øµ Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ"""

    else:
        result += """ğŸ“‹ **ØªÙ‚ÙŠÙŠÙ… Ø¹Ø§Ù…:**

Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¹Ù„Ø§Ù…Ø§Øª Ø®Ø·ÙŠØ±Ø© ÙˆØ§Ø¶Ø­Ø©ØŒ Ù„ÙƒÙ†:

âœ… **Ø§Ù„ØªÙˆØµÙŠØ§Øª:**
- Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨
- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£ÙŠ Ø£Ø¹Ø±Ø§Ø¶ Ø¬Ø¯ÙŠØ¯Ø©
- ÙØ­ÙˆØµØ§Øª Ø±ÙˆØªÙŠÙ†ÙŠØ© Ø³Ù†ÙˆÙŠØ©
- Ù†Ù…Ø· Ø­ÙŠØ§Ø© ØµØ­ÙŠ

âš ï¸ **Ù…Ù„Ø§Ø­Ø¸Ø©:** Ù‡Ø°Ø§ ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ø¨Ø³ÙŠØ·. 
Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ OpenAI API."""

    result += "\n\nâš ï¸ *Ù‡Ø°Ø§ ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„ÙŠ. Ø§Ø³ØªØ´Ø± Ø·Ø¨ÙŠØ¨Ø§Ù‹ Ù…ØªØ®ØµØµØ§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹*"
    
    return result


# ====================================================
# ğŸ§  Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ ØªÙ‚Ø§Ø±ÙŠØ± Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# ====================================================
async def analyze_saved_reports(limit: int = 10):
    """
    ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    
    Args:
        limit: Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„ØªØ­Ù„ÙŠÙ„ (Ø§ÙØªØ±Ø§Ø¶ÙŠ: 10)
    
    Returns:
        str: Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„
    """
    try:
        reports = Report.all()
        if not reports:
            return "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù„ØªØ­Ù„ÙŠÙ„Ù‡Ø§."
        
        # ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        reports_to_analyze = reports[:limit] if limit else reports
        
        analysis_summary = []
        for rep in reports_to_analyze:
            text = f"{rep.patient_name}: {rep.complaint_text or ''} {rep.doctor_decision or ''}"
            result = await analyze_reports(text)
            
            # ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            summary = summarize_text(result, max_length=200)
            analysis_summary.append(f"ğŸ§¾ **{rep.patient_name}**\n{summary}\n")
        
        total = len(reports)
        analyzed = len(reports_to_analyze)
        
        header = f"ğŸ“Š **ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±**\n\nØªÙ… ØªØ­Ù„ÙŠÙ„ {analyzed} Ù…Ù† Ø£ØµÙ„ {total} ØªÙ‚Ø±ÙŠØ±\n\n{'='*50}\n\n"
        
        return header + "\n".join(analysis_summary)
        
    except Exception as e:
        logger.error(f"âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: {e}")
        return f"âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: {e}"


# ====================================================
# ğŸ” Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
# ====================================================

def is_ai_available() -> bool:
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± OpenAI"""
    return OPENAI_API_KEY is not None


def get_ai_status() -> dict:
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ù†Ø¸Ø§Ù… AI"""
    return {
        "enabled": True,
        "openai_available": OPENAI_API_KEY is not None,
        "model": OPENAI_MODEL if OPENAI_API_KEY else "simple",
        "status": "âœ… Ù…ØªØµÙ„ (OpenAI)" if OPENAI_API_KEY else "âš ï¸ ØªØ­Ù„ÙŠÙ„ Ø¨Ø³ÙŠØ·"
    }
